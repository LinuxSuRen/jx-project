buildPack: go-cli
dockerRegistryOwner: jenkinsxio
pipelineConfig:
  pipelines:
    overrides:
      - name: helm-template
        step:
          sh: echo disabled
      - name: make-linux
        step:
          sh: make linux
          image: golang:1.15
      - name: make-test
        step:
          sh: make test
          image: golang:1.15
      - name: container-build
        step:
          sh: /kaniko/executor $KANIKO_FLAGS --cache=true --cache-dir=/workspace --context=/workspace/source --dockerfile=/workspace/source/Dockerfile-preview --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/jx-project:$VERSION --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
          image: gcr.io/kaniko-project/executor
          env:
          - name: NO_GOOGLE_APPLICATION_CREDENTIALS
            value: "true"
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: ""

    release:
      pipeline:
        stages:
          - agent:
              image: gcr.io/jenkinsxio/builder-go
            name: chart
            options:
              containerOptions:
                resources:
                  limits:
                    cpu: 3
                    memory: 4072Mi
                  requests:
                    cpu: 2
                    memory: 3048Mi
            steps:
              - name: release-binary
                command: make release
                image: golang:1.15
              - name: changelog
                command: jx step changelog --verbose --header-file=hack/changelog-header.md --version=$VERSION --rev=$PULL_BASE_SHA --output-markdown=changelog.md --update-release=false
              - name: upload-binaries
                command: make goreleaser
                image: gcr.io/jenkinsxio/step-go-releaser
              - command: ./promote.sh
                dir: /workspace/source
                name: promote-release